<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.9.xsd">
    <property name="progetto"/>
    <property name="descProgetto"/>
    <property name="noteProgetto"/>

    <property name="modulo"/>
    <property name="descModulo"/>

    <property name="istanza"/>
    <property name="descIstanza"/>
    <property name="ammIstanza"/>

    <property name="versione"/>

    <property name="targetUsername"/>
    <property name="targetPassword"/>

    <property name="ente"/>

    <changeSet id="201905311217-3" author="mturra" runOnChange="true">
        <preConditions onFail="MARK_RAN" onFailMessage="Esiste l'istanza ${istanza} quindi salto l'inserimento">
            <sqlCheck expectedResult="0">select count(1) from AD4_ISTANZE where ISTANZA='${istanza}'</sqlCheck>
        </preConditions>
        <comment>Inserimento dell'istanza '${istanza}'</comment>
        <sql dbms="oracle" endDelimiter="\">
            declare
            d_psw varchar2(30) := '${targetPassword}';
            begin
            -- TODO: prima di chiamare crypt deve essere caricato il package, conviene inserire la pwd cryptata al termine.
            ad4_crypt.crypt_password(d_psw, 'STANDARD');
            Insert into AD4_ISTANZE
            (ISTANZA, PROGETTO, ENTE, DESCRIZIONE, USER_ORACLE, PASSWORD_ORACLE, DISLOCAZIONE, DISLOCAZIONE_TEMPORANEA, INSTALLAZIONE, VERSIONE, LINGUA)
            Values ('${istanza}', '${progetto}', '${ente}', '${descIstanza}', '${targetUsername}', d_psw, '\temp','\temp','RG.DB',
                    '@' ||substr('${versione}',1, decode(instr('${versione}','-') -1 ,-1,length('${versione}'),instr('${versione}','-') -1)), 'I');
            end;
        </sql>
    </changeSet>


    <changeSet id="202110251507" author="fmarzulli" runOnChange="true">
        <preConditions onFail="MARK_RAN" onFailMessage="Esiste l'istanza ISTALDAP quindi salto l'inserimento">
            <sqlCheck expectedResult="0">select count(1) from AD4_ISTANZE where ISTANZA='ISTALDAP'</sqlCheck>
        </preConditions>
        <comment>Inserimento dell'istanza ISTALDAP</comment>
        <sql dbms="oracle" endDelimiter="\">
            declare
            d_psw varchar2(30) := '${targetPassword}';
            begin
            ad4_crypt.crypt_password(d_psw, 'STANDARD');
            Insert into AD4_ISTANZE
            (ISTANZA, PROGETTO, ENTE, DESCRIZIONE, USER_ORACLE, PASSWORD_ORACLE, DISLOCAZIONE, DISLOCAZIONE_TEMPORANEA, INSTALLAZIONE, LINGUA)
            Values ('ISTALDAP', 'PROGLDAP', '${ente}', 'Istanza generica per accesso LDAP', '${targetUsername}', d_psw, '\temp', '\temp', '','I');
            end;
        </sql>
    </changeSet>

</databaseChangeLog>