<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.9.xsd">
    <property name="username" value="AD4"/>
    <property name="nominativo" value="AD4"/>
    <property name="userPwd" value="AD4"/>
    <changeSet id="201903121354" author="mturra" runOnChange="true">
        <preConditions onFail="CONTINUE" onFailMessage="Esiste l'istanza ${istanza} quindi salto l'inserimento">
            <sqlCheck expectedResult="0">select count(1) from UTENTI where UTENTE='${username}'</sqlCheck>
        </preConditions>
        <comment>Inserimento utente ${username}</comment>
        <sql dbms="oracle"
             endDelimiter="/"
             splitStatements="true"
             stripComments="true">
            declare
            d_psw varchar2(30) := '${userPwd}';
            begin
            ad4_crypt.crypt_password(d_psw, 'STANDARD');
            Insert into UTENTI
            (UTENTE, PASSWORD, NOMINATIVO, DATA_PASSWORD, ULTIMO_TENTATIVO, NUMERO_TENTATIVI,
            TIPO_UTENTE, ID_UTENTE, STATO, DATA_INSERIMENTO, UTENTE_AGGIORNAMENTO,
            DATA_AGGIORNAMENTO, LINGUA, GRUPPO_LAVORO, PWD_DA_MODIFICARE)
            Values
            ('${username}', d_psw, '${nominativo}', null, null, 0,
            'U', 0, 'U', null, '',
            null, '*', '', 'NO');
            end;
            /
        </sql>
        <rollback>
            <delete tableName="UTENTI">
                <where>UTENTE=${username}</where>
            </delete>
        </rollback>
    </changeSet>
    <changeSet author="snegroni" id="loadData-ad4-utenti_base">
        <loadData encoding="UTF-8"
                  relativeToChangelogFile="true"
                  file="install/data/csv/ad4_utenti_base.csv"
                  tableName="UTENTI">
            <column name="UTENTE" type="STRING"/>
            <column name="NOMINATIVO" type="STRING"/>
            <column name="TIPO_UTENTE" type="STRING"/>
        </loadData>
    </changeSet>
</databaseChangeLog>