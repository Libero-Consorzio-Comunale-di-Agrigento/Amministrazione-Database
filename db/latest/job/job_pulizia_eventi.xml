<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.9.xsd">

    <changeSet id="201911041612" author="snegroni">
        <comment>Creazione job per cancellazione tabella eventi disabilitato</comment>
            <sql dbms="oracle"
                 endDelimiter="\"
                 splitStatements="true"
                 stripComments="true">
                    declare
                    v_jobs number;
                    begin
                    select count(*)
                    into v_jobs
                    from user_jobs
                    where upper(what) like ('%GESTIONE_DATI_LOCALI.ELIMINA_ACCESSI_MAX_RETENTION%');
                    if v_jobs = 0 then
                    DECLARE
                    X NUMBER;
                    BEGIN
                    SYS.DBMS_JOB.SUBMIT
                    ( job       => X
                    ,what      => 'begin GESTIONE_DATI_LOCALI.ELIMINA_ACCESSI_MAX_RETENTION; end;'
                    ,next_date => sysdate
                    ,interval  => 'TRUNC(SYSDATE+1)+2/24'
                    ,no_parse  => FALSE
                    );
                    SYS.DBMS_JOB.BROKEN
                    (job    => X,
                    broken => TRUE);
                    COMMIT;
                    END;
                    end if;
                    end;
                    /
            </sql>
    </changeSet>
</databaseChangeLog>